<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.powerrangers.system.modules.EventManagement.dao.EventMapper">

    <sql id="event_name">
        <if test="eventName != null and eventName.length() > 0">
            where host_id = #{hostId} and event_name = #{eventName};
        </if>
    </sql>

    <insert id="createEvent" parameterType="com.powerrangers.system.modules.EventManagement.service.dto.SmallEventDTO">
        insert into sys_event (host_id, event_name, event_type, location,
                               start_time, end_time, is_displayed, image, description)
        values (#{hostId}, #{eventName}, #{eventType}, #{location},
                #{startTime}, #{endTime}, #{isDisplayed}, #{image}, #{description});
    </insert>

    <insert id="createEventInsertFullPriceTicket" parameterType="com.powerrangers.system.modules.EventManagement.service.dto.SmallEventDTO">
        insert into event_ticket (event_id, ticket_type, ticket_amount, ticket_price)
        values ((select event_id from sys_event where host_id = #{hostId} and event_name = #{eventName}), 1, #{ticketAmount}, #{ticketPrice});
    </insert>

    <select id="checkExist" parameterType="com.powerrangers.system.modules.EventManagement.service.dto.EventModifyDTO"
            resultType="Integer">
        select count(*) from sys_event
        <include refid="event_name"/>;
    </select>

    <select id="updateEventName" parameterType="com.powerrangers.system.modules.EventManagement.service.dto.EventModifyDTO">
        update sys_event set event_name = #{newString}
        <include refid="event_name"/>;
    </select>

    <select id="updateEventTime" parameterType="com.powerrangers.system.modules.EventManagement.service.dto.EventModifyDTO">
        update sys_event set start_time = #{newStartTime}, end_time = #{newEndTime}
        <include refid="event_name"/>;
    </select>

    <select id="updateEventDescription" parameterType="com.powerrangers.system.modules.EventManagement.service.dto.EventModifyDTO">
        update sys_event set description = #{newString}
        <include refid="event_name"/>;
    </select>

    <select id="updateEventAddress" parameterType="com.powerrangers.system.modules.EventManagement.service.dto.EventModifyDTO">
        update sys_event set location = #{newString}, site_description = #{secondNewString}
        <include refid="event_name"/>;
    </select>

    <select id="updateEventType" parameterType="com.powerrangers.system.modules.EventManagement.service.dto.EventModifyDTO">
        update sys_event set event_type = #{newInteger}
        <include refid="event_name"/>;
    </select>

    <select id="changeEventCancelState" parameterType="com.powerrangers.system.modules.EventManagement.service.dto.EventModifyDTO">
        update sys_event set is_cancelled = #{newInteger}
        <include refid="event_name"/>;
    </select>

    <select id="changeEventDisplayState" parameterType="com.powerrangers.system.modules.EventManagement.service.dto.EventModifyDTO">
        update sys_event set is_displayed = #{newInteger}
        <include refid="event_name"/>;
    </select>

    <select id="changeEventTag" parameterType="com.powerrangers.system.modules.EventManagement.service.dto.EventModifyDTO">
        update sys_event set event_tag = #{newString}
        <include refid="event_name"/>;
    </select>

    <select id="queryEvent" parameterType="com.powerrangers.system.modules.EventManagement.service.dto.EventModifyDTO"
                            resultType="com.powerrangers.system.modules.EventManagement.service.dto.EventDTO">
        select * from sys_event
        <include refid="event_name"/>;
    </select>

    <select id="getEvents" parameterType="integer"
                            resultType="com.powerrangers.system.modules.EventManagement.service.dto.EventDTO">
        select * from sys_event where host_id = #{hostId} order by start_time desc;
    </select>

    <select id="getAllEvents" parameterType="com.powerrangers.system.modules.EventManagement.service.dto.EventFilterDTO"
                                resultType="com.powerrangers.system.modules.EventManagement.service.dto.EventDTO">
        select e.*, t.ticket_type, t.ticket_amount, t.ticket_price from sys_event e, event_ticket t
        <where>
            e.event_id = t.event_id and t.ticket_type = 1
            <if test="location != null and location.length() != 0 and location != ''">
                and location = #{location}
            </if>
            <if test="starLevel != null and starLevel != 0 and starLevel lte 5">
                and star_level <![CDATA[ >= ]]> #{starLevel}
            </if>
            <if test="minPrice != null and maxPrice != null and minPrice lte maxPrice">
                and t.ticket_price <![CDATA[ >= ]]> #{minPrice}
                and t.ticket_price <![CDATA[ <= ]]> #{maxPrice}
            </if>
            <if test="online != null">
                and online = #{online}
            </if>
            <if test="eventType != null and eventType != 0">
                and event_type = #{eventType}
            </if>
        </where>
        order by start_time desc;
    </select>

    <select id="searchEvents" parameterType="string"
            resultType="com.powerrangers.system.modules.EventManagement.service.dto.EventDTO">
        select * from sys_event where event_name LIKE CONCAT('%',#{keyWords},'%') or event_tag LIKE CONCAT('%',#{keyWords},'%')
        or event_type in (select type_id from event_type where type_name LIKE CONCAT('%',#{keyWords},'%'))
        or host_id in (select id from sys_user where username LIKE CONCAT('%',#{keyWords},'%'));
    </select>
</mapper>